---
title: ä»€ä¹ˆæ˜¯rpc
date: 2020-07-21 15:46
tags: 
- Golang
- è®¡ç®—æœºç½‘ç»œ
description: è®°å½•ä¸€ä¸‹å­¦ä¹ rpcçš„è¿‡ç¨‹ä»¥åŠä¸€ä¸ªå°ä¾‹å­ã€‚
---



### åŽŸç†ä»‹ç»

**RPC çš„å…¨ç§°æ˜¯ Remote Procedure Call æ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ã€‚**

å®ƒå…è®¸ç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªåœ°å€ç©ºé—´ï¼ˆé€šå¸¸æ˜¯å…±äº«ç½‘ç»œçš„å¦ä¸€å°æœºå™¨ä¸Šï¼‰çš„è¿‡ç¨‹æˆ–å‡½æ•°ï¼Œè€Œä¸ç”¨ç¨‹åºå‘˜æ˜¾å¼ç¼–ç è¿™ä¸ªè¿œç¨‹è°ƒç”¨çš„ç»†èŠ‚ã€‚å³æ— è®ºæ˜¯è°ƒç”¨æœ¬åœ°æŽ¥å£/æœåŠ¡çš„è¿˜æ˜¯è¿œç¨‹çš„æŽ¥å£/æœåŠ¡ï¼Œæœ¬è´¨ä¸Šç¼–å†™çš„è°ƒç”¨ä»£ç åŸºæœ¬ç›¸åŒã€‚

æ¯”å¦‚ä¸¤å°æœåŠ¡å™¨Aï¼ŒBï¼Œä¸€ä¸ªåº”ç”¨éƒ¨ç½²åœ¨AæœåŠ¡å™¨ä¸Šï¼Œæƒ³è¦è°ƒç”¨BæœåŠ¡å™¨ä¸Šåº”ç”¨æä¾›çš„å‡½æ•°æˆ–è€…æ–¹æ³•ï¼Œç”±äºŽä¸åœ¨ä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œä¸èƒ½ç›´æŽ¥è°ƒç”¨ï¼Œè¿™æ—¶å€™éœ€è¦é€šè¿‡å°±å¯ä»¥åº”ç”¨RPCæ¡†æž¶çš„å®žçŽ°æ¥è§£å†³ã€‚

> RPC ä¼šéšè—åº•å±‚çš„é€šè®¯ç»†èŠ‚ï¼ˆä¸éœ€è¦ç›´æŽ¥å¤„ç†Socketé€šè®¯æˆ–httpé€šè®¯ï¼‰
>
> RPC æ˜¯ä¸€ä¸ªè¯·æ±‚å“åº”æ¨¡åž‹ã€‚å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›žå“åº”ï¼ˆç±»ä¼¼äºŽhttpçš„å·¥ä½œæ–¹å¼ï¼‰
>
> RPC åœ¨ä½¿ç”¨å½¢å¼ä¸Šåƒè°ƒç”¨æœ¬åœ°å‡½æ•°ï¼ˆæˆ–æ–¹æ³•ï¼‰ä¸€æ ·åŽ»è°ƒç”¨è¿œç¨‹çš„å‡½æ•°ï¼ˆæˆ–æ–¹æ³•ï¼‰ã€‚

ä¸‹é¢åˆ†åˆ«ä»‹ç»æ ¸å¿ƒ RPC æ¡†æž¶çš„é‡è¦ç»„æˆï¼š

- **å®¢æˆ·ç«¯ï¼ˆClientï¼‰ï¼š**æœåŠ¡è°ƒç”¨æ–¹ã€‚
- **å®¢æˆ·ç«¯å­˜æ ¹ï¼ˆClient Stubï¼‰ï¼š**å­˜æ”¾æœåŠ¡ç«¯åœ°å€ä¿¡æ¯ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚å‚æ•°æ•°æ®ä¿¡æ¯æ‰“åŒ…æˆç½‘ç»œæ¶ˆæ¯ï¼Œå†é€šè¿‡ç½‘ç»œä¼ è¾“å‘é€ç»™æœåŠ¡ç«¯ã€‚
- **æœåŠ¡ç«¯å­˜æ ¹ï¼ˆServer Stubï¼‰ï¼š**æŽ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚æ¶ˆæ¯å¹¶è¿›è¡Œè§£åŒ…ï¼Œç„¶åŽå†è°ƒç”¨æœ¬åœ°æœåŠ¡è¿›è¡Œå¤„ç†ã€‚
- **æœåŠ¡ç«¯ï¼ˆServerï¼‰ï¼š**æœåŠ¡çš„çœŸæ­£æä¾›è€…ã€‚
- **Network Serviceï¼š**åº•å±‚ä¼ è¾“ï¼Œå¯ä»¥æ˜¯ TCP æˆ– HTTPã€‚



![](http://p99.pstatp.com/large/pgc-image/1540190765251e9d1633416)

ä¸€æ¬¡å®Œæ•´çš„RPCè°ƒç”¨æµç¨‹ï¼ˆåŒæ­¥è°ƒç”¨ï¼Œå¼‚æ­¥å¦è¯´ï¼‰å¦‚ä¸‹ï¼š

> 1ï¼‰æœåŠ¡æ¶ˆè´¹æ–¹ï¼ˆclientï¼‰è°ƒç”¨ä»¥æœ¬åœ°è°ƒç”¨æ–¹å¼è°ƒç”¨æœåŠ¡ï¼›
>
> 2ï¼‰client stubæŽ¥æ”¶åˆ°è°ƒç”¨åŽè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰ç»„è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“ï¼›
>
> 3ï¼‰client stubæ‰¾åˆ°æœåŠ¡åœ°å€ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼›
>
> 4ï¼‰server stubæ”¶åˆ°æ¶ˆæ¯åŽè¿›è¡Œè§£ç ï¼›
>
> 5ï¼‰server stubæ ¹æ®è§£ç ç»“æžœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡ï¼›
>
> 6ï¼‰æœ¬åœ°æœåŠ¡æ‰§è¡Œå¹¶å°†ç»“æžœè¿”å›žç»™server stubï¼›
>
> 7ï¼‰server stubå°†è¿”å›žç»“æžœæ‰“åŒ…æˆæ¶ˆæ¯å¹¶å‘é€è‡³æ¶ˆè´¹æ–¹ï¼›
>
> 8ï¼‰client stubæŽ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œè§£ç ï¼›
>
> 9ï¼‰æœåŠ¡æ¶ˆè´¹æ–¹å¾—åˆ°æœ€ç»ˆç»“æžœã€‚

RPCæ¡†æž¶çš„ç›®æ ‡å°±æ˜¯è¦2~8è¿™äº›æ­¥éª¤éƒ½å°è£…èµ·æ¥ï¼Œè®©ç”¨æˆ·å¯¹è¿™äº›ç»†èŠ‚é€æ˜Žã€‚



**åŸºäºŽ TCP åè®®çš„ RPC è°ƒç”¨**
ç”±æœåŠ¡çš„è°ƒç”¨æ–¹ä¸ŽæœåŠ¡çš„æä¾›æ–¹å»ºç«‹ Socket è¿žæŽ¥ï¼Œå¹¶ç”±æœåŠ¡çš„è°ƒç”¨æ–¹é€šè¿‡ Socket å°†éœ€è¦è°ƒç”¨çš„æŽ¥å£åç§°ã€æ–¹æ³•åç§°å’Œå‚æ•°åºåˆ—åŒ–åŽä¼ é€’ç»™æœåŠ¡çš„æä¾›æ–¹ï¼ŒæœåŠ¡çš„æä¾›æ–¹ååºåˆ—åŒ–åŽå†åˆ©ç”¨åå°„è°ƒç”¨ç›¸å…³çš„æ–¹æ³•ã€‚

æœ€åŽå°†ç»“æžœè¿”å›žç»™æœåŠ¡çš„è°ƒç”¨æ–¹ï¼Œæ•´ä¸ªåŸºäºŽ TCP åè®®çš„ RPC è°ƒç”¨å¤§è‡´å¦‚æ­¤ã€‚

ä½†æ˜¯åœ¨å®žä¾‹åº”ç”¨ä¸­åˆ™ä¼šè¿›è¡Œä¸€ç³»åˆ—çš„å°è£…ï¼Œå¦‚ RMI ä¾¿æ˜¯åœ¨ TCP åè®®ä¸Šä¼ é€’å¯åºåˆ—åŒ–çš„ Java å¯¹è±¡ã€‚

**åŸºäºŽ HTTP åè®®çš„ RPC è°ƒç”¨**
è¯¥æ–¹æ³•æ›´åƒæ˜¯è®¿é—®ç½‘é¡µä¸€æ ·ï¼Œåªæ˜¯å®ƒçš„è¿”å›žç»“æžœæ›´åŠ å•ä¸€ç®€å•ã€‚

**å…¶å¤§è‡´æµç¨‹ä¸ºï¼š**ç”±æœåŠ¡çš„è°ƒç”¨è€…å‘æœåŠ¡çš„æä¾›è€…å‘é€è¯·æ±‚ï¼Œè¿™ç§è¯·æ±‚çš„æ–¹å¼å¯èƒ½æ˜¯ GETã€POSTã€PUTã€DELETE ç­‰ä¸­çš„ä¸€ç§ï¼ŒæœåŠ¡çš„æä¾›è€…å¯èƒ½ä¼šæ ¹æ®ä¸åŒçš„è¯·æ±‚æ–¹å¼åšå‡ºä¸åŒçš„å¤„ç†ï¼Œæˆ–è€…æŸä¸ªæ–¹æ³•åªå…è®¸æŸç§è¯·æ±‚æ–¹å¼ã€‚

è€Œè°ƒç”¨çš„å…·ä½“æ–¹æ³•åˆ™æ˜¯æ ¹æ® URL è¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼Œè€Œæ–¹æ³•æ‰€éœ€è¦çš„å‚æ•°å¯èƒ½æ˜¯å¯¹æœåŠ¡è°ƒç”¨æ–¹ä¼ è¾“è¿‡åŽ»çš„ XML æ•°æ®æˆ–è€… JSON æ•°æ®è§£æžåŽçš„ç»“æžœï¼Œæœ€åŽè¿”å›ž JOSN æˆ–è€… XML çš„æ•°æ®ç»“æžœã€‚

ç”±äºŽç›®å‰æœ‰å¾ˆå¤šå¼€æºçš„ Web æœåŠ¡å™¨ï¼Œå¦‚ Tomcatï¼Œæ‰€ä»¥å…¶å®žçŽ°èµ·æ¥æ›´åŠ å®¹æ˜“ï¼Œå°±åƒåš Web é¡¹ç›®ä¸€æ ·ã€‚

**ä¸¤ç§æ–¹å¼å¯¹æ¯”**
åŸºäºŽ TCP çš„åè®®å®žçŽ°çš„ RPC è°ƒç”¨ï¼Œç”±äºŽ TCP åè®®å¤„äºŽåè®®æ ˆçš„ä¸‹å±‚ï¼Œèƒ½å¤Ÿæ›´åŠ çµæ´»åœ°å¯¹åè®®å­—æ®µè¿›è¡Œå®šåˆ¶ï¼Œå‡å°‘ç½‘ç»œå¼€é”€ï¼Œæé«˜æ€§èƒ½ï¼Œå®žçŽ°æ›´å¤§çš„åžåé‡å’Œå¹¶å‘æ•°ã€‚

ä½†æ˜¯éœ€è¦æ›´å¤šå…³æ³¨åº•å±‚å¤æ‚çš„ç»†èŠ‚ï¼Œå®žçŽ°çš„ä»£ä»·æ›´é«˜ã€‚åŒæ—¶å¯¹ä¸åŒå¹³å°ï¼Œå¦‚å®‰å“ï¼ŒiOS ç­‰ï¼Œéœ€è¦é‡æ–°å¼€å‘å‡ºä¸åŒçš„å·¥å…·åŒ…æ¥è¿›è¡Œè¯·æ±‚å‘é€å’Œç›¸åº”è§£æžï¼Œå·¥ä½œé‡å¤§ï¼Œéš¾ä»¥å¿«é€Ÿå“åº”å’Œæ»¡è¶³ç”¨æˆ·éœ€æ±‚ã€‚

åŸºäºŽ HTTP åè®®å®žçŽ°çš„ RPC åˆ™å¯ä»¥ä½¿ç”¨ JSON å’Œ XML æ ¼å¼çš„è¯·æ±‚æˆ–å“åº”æ•°æ®ã€‚

è€Œ JSON å’Œ XML ä½œä¸ºé€šç”¨çš„æ ¼å¼æ ‡å‡†ï¼ˆä½¿ç”¨ HTTP åè®®ä¹Ÿéœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä¸è¿‡è¿™ä¸æ˜¯è¯¥åè®®ä¸‹å…³å¿ƒçš„å†…å®¹ï¼Œæˆç†Ÿçš„ Web ç¨‹åºå·²ç»åšå¥½äº†åºåˆ—åŒ–å†…å®¹ï¼‰ï¼Œå¼€æºçš„è§£æžå·¥å…·å·²ç»ç›¸å½“æˆç†Ÿï¼Œåœ¨å…¶ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ä¼šéžå¸¸ä¾¿æ·å’Œç®€å•ã€‚

ä½†æ˜¯ç”±äºŽ HTTP åè®®æ˜¯ä¸Šå±‚åè®®ï¼Œå‘é€åŒ…å«åŒç­‰å†…å®¹çš„ä¿¡æ¯ï¼Œä½¿ç”¨ HTTP åè®®ä¼ è¾“æ‰€å ç”¨çš„å­—èŠ‚æ•°ä¼šæ¯”ä½¿ç”¨ TCP åè®®ä¼ è¾“æ‰€å ç”¨çš„å­—èŠ‚æ•°æ›´é«˜ã€‚

å› æ­¤åœ¨åŒç­‰ç½‘ç»œä¸‹ï¼Œé€šè¿‡ HTTP åè®®ä¼ è¾“ç›¸åŒå†…å®¹ï¼Œæ•ˆçŽ‡ä¼šæ¯”åŸºäºŽ TCP åè®®çš„æ•°æ®æ•ˆçŽ‡è¦ä½Žï¼Œä¿¡æ¯ä¼ è¾“æ‰€å ç”¨çš„æ—¶é—´ä¹Ÿä¼šæ›´é•¿ï¼Œå½“ç„¶åŽ‹ç¼©æ•°æ®ï¼Œèƒ½å¤Ÿç¼©å°è¿™ä¸€å·®è·ã€‚



**å‚è€ƒ**ï¼šhttps://zhuanlan.zhihu.com/p/88597686



### ä¾‹å­

server/main.go

```go
package main

import (
	"errors"
	"log"
	"net"
	"net/rpc"
	"net/rpc/jsonrpc"
)

type Args struct {
	A, B int
}

type Compute int

func (t *Compute) Multiply(args *Args, reply *int) error {
	*reply = args.A * args.B
	log.Printf("receive request %d * %d",args.A,args.B)
	return nil
}

func (t *Compute) Div(args *Args,reply *int) error  {
	if args.B==0{
		return errors.New("divider by 0")
	}
	*reply = args.A/args.B
	log.Printf("receive request %d / %d",args.A,args.B)
	return nil
}

func main() {
	l, err := net.Listen("tcp", ":1234")
	if err != nil {
		log.Fatal("listen error:", err)
	}

	arith := new(Compute)
	rpc.Register(arith)

	for {
		conn, err := l.Accept()
		if err != nil {
			log.Fatal("accept error:", err)
		}

		// æ³¨æ„è¿™ä¸€è¡Œ
		go rpc.ServeCodec(jsonrpc.NewServerCodec(conn))
	}
}
```



client/main.go

```go
package main

import (
	"log"
	"net"
	"net/rpc"
	"net/rpc/jsonrpc"
)

type Args struct {
	A, B int
}

func main() {
	conn, err := net.Dial("tcp", ":1234")
	if err != nil {
		log.Fatal("dial error:", err)
	}

	// è¿™é‡Œï¼Œè¿™é‡ŒðŸ˜
	client := rpc.NewClientWithCodec(jsonrpc.NewClientCodec(conn))

	args := &Args{16, 0}
	var reply int
	err = client.Call("Compute.Multiply", args, &reply)
	if err != nil {
		log.Fatal("Multiply error:", err)
	}
	log.Printf("Multiply: %d*%d=%d\n", args.A, args.B, reply)

	err = client.Call("Compute.Div", args, &reply)
	if err != nil {
		log.Fatal("Div error:", err)
	}
	log.Printf("Div: %d/%d=%d\n", args.A, args.B, reply)
}

```

å…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œå†è¿è¡Œå®¢æˆ·ç«¯ï¼Œç»“æžœï¼š

> 2020/07/23 17:17:21 Multiply: 16*2=32
> 2020/07/23 17:17:21 Div: 16/2=8